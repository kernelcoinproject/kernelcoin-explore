{{define "address.html"}}
<div class="row mb-4">
  <div class="col-12">
    <h2 style="color: var(--primary); margin-bottom: 1.5rem;">
      <i class="fas fa-map-marker-alt"></i> Address Information
    </h2>
  </div>
</div>

{{if .AddressData.IsValid}}
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title" style="color: var(--primary);">
          <i class="fas fa-search"></i> Scan Options
        </h5>
        <div class="mt-3">
          <div class="row">
            <div class="col-md-6 mb-2">
              <button type="button" id="utxolookup" class="btn btn-primary w-100">
                <i class="fas fa-coins"></i> Scan UTXO Set
              </button>
              <small class="text-muted d-block mt-1">Total balance & unspent outputs</small>
            </div>
            <div class="col-md-6 mb-2">
              <button type="button" id="scanfilters" class="btn btn-info w-100">
                <i class="fas fa-filter"></i> Scan Blockfilters
              </button>
              <small class="text-muted d-block mt-1">All relevant blocks & transactions</small>
            </div>
          </div>
          <div class="progress invisible mt-3" id="loadingbardiv" style="height: 25px;">
            <div id="loadingbar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">0%</div>
          </div>
          <div id="result" class="mt-3"></div>
          <div id="result2" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-lg-6">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title" style="color: var(--primary);">
          <i class="fas fa-wallet"></i> Address Details
        </h5>
        <div class="mt-3">
          <div class="mb-3">
            <label class="form-label" style="color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px;">Address</label>
            <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border-color); padding: 1rem; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 0.9rem; word-break: break-all; color: var(--secondary);">
              {{.AddressData.Address}}
            </div>
          </div>
          {{if gt .AddressData.WitnessVersion 0}}
          <div class="mb-3">
            <label class="form-label" style="color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px;">Witness Version</label>
            <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border-color); padding: 1rem; border-radius: 6px; color: var(--text-primary);">
              {{.AddressData.WitnessVersion}}
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label" style="color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px;">Witness Program</label>
            <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border-color); padding: 1rem; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 0.9rem; word-break: break-all; color: var(--secondary);">
              {{.AddressData.WitnessProgram}}
            </div>
          </div>
          {{end}}
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title" style="color: var(--primary);">
          <i class="fas fa-code"></i> Script Information
        </h5>
        <div class="mt-3">
          <div class="mb-3">
            <label class="form-label" style="color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px;">scriptPubKey</label>
            <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border-color); padding: 1rem; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 0.85rem; word-break: break-all; color: var(--secondary); max-height: 200px; overflow-y: auto;">
              {{.AddressData.ScriptPubKey}}
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label" style="color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px;">Type</label>
            <div>
              {{if .AddressData.IsScript}}
                <span class="badge bg-warning">Script</span>
              {{else}}
                <span class="badge bg-success">Address</span>
              {{end}}
              {{if .AddressData.IsWitness}}
                <span class="badge bg-info">Witness</span>
              {{end}}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{{else}}
<div class="row mb-4">
  <div class="col-12">
    <div style="background: rgba(255, 68, 68, 0.1); border: 2px solid var(--error); border-radius: 12px; padding: 2rem; text-align: center;">
      <h4 style="color: var(--error); margin-bottom: 0.5rem;">
        <i class="fas fa-times-circle"></i> Invalid Address
      </h4>
      <p style="color: var(--text-secondary); margin-bottom: 1rem;">
        The address you searched for is not valid on the {{.NetworkName}} network.
      </p>
      <a href="{{.HomeLink}}" class="btn btn-primary btn-sm">
        <i class="fas fa-home"></i> Back to Home
      </a>
    </div>
  </div>
</div>
{{end}}

<script>
document.addEventListener("DOMContentLoaded", function() {
  var scan_ongoing = false;
  var address = "{{.AddressData.Address}}";

  // Scan UTXO Set
  document.getElementById("utxolookup").addEventListener("click", function() {
    if (scan_ongoing) return;
    scan_ongoing = true;
    
    var refreshIntervalId = 0;
    document.getElementById("loadingbardiv").classList.remove("invisible");
    document.getElementById("loadingbar").setAttribute('aria-valuenow', 0);
    document.getElementById("loadingbar").style.width = '0%';
    document.getElementById("result").innerHTML = "<div style=\"color: var(--text-primary); padding: 1rem; background: rgba(0, 0, 0, 0.3); border-radius: 6px; border: 1px solid var(--border-color);\">Scanning UTXO Set... (can take a while)</div>";
    
    fetch("?search=" + encodeURIComponent(address) + "&utxolookup=1")
      .then(response => response.text())
      .then(data => {
        document.getElementById("result").innerHTML = data;
        clearInterval(refreshIntervalId);
        document.getElementById("loadingbardiv").classList.add("invisible");
        scan_ongoing = false;
      });
    
    refreshIntervalId = setInterval(function() {
      fetch("?search=" + encodeURIComponent(address) + "&utxolookupstatus=1")
        .then(response => response.text())
        .then(data => {
          if (data === "") {
            clearInterval(refreshIntervalId);
            document.getElementById("loadingbardiv").classList.add("invisible");
            scan_ongoing = false;
          } else {
            document.getElementById("result").innerHTML = "<div style=\"color: var(--text-primary); padding: 1rem; background: rgba(0, 0, 0, 0.3); border-radius: 6px; border: 1px solid var(--border-color);\">Scanning UTXO Set... " + data + "%</div>";
            document.getElementById("loadingbar").setAttribute('aria-valuenow', data);
            document.getElementById("loadingbar").style.width = data + '%';
            document.getElementById("loadingbar").innerHTML = data + '%';
          }
        });
    }, 1000);
  });

  // Scan Blockfilters
  document.getElementById("scanfilters").addEventListener("click", function() {
    if (scan_ongoing) return;
    scan_ongoing = true;
    
    var refreshIntervalId = 0;
    document.getElementById("loadingbardiv").classList.remove("invisible");
    document.getElementById("loadingbar").setAttribute('aria-valuenow', 0);
    document.getElementById("loadingbar").style.width = '0%';
    document.getElementById("result").innerHTML = "<div style=\"color: var(--text-primary); padding: 1rem; background: rgba(0, 0, 0, 0.3); border-radius: 6px; border: 1px solid var(--border-color);\">Scanning Blockfilters... (can take a while)</div>";
    
    fetch("?search=" + encodeURIComponent(address) + "&scanfilters=1&startheight=1")
      .then(response => response.text())
      .then(data => {
        document.getElementById("result").innerHTML = data;
        clearInterval(refreshIntervalId);
        document.getElementById("loadingbardiv").classList.add("invisible");
        scan_ongoing = false;
      });
    
    refreshIntervalId = setInterval(function() {
      fetch("?search=" + encodeURIComponent(address) + "&scanfiltersstatus=1")
        .then(response => response.text())
        .then(data => {
          if (data === "") {
            clearInterval(refreshIntervalId);
            document.getElementById("loadingbardiv").classList.add("invisible");
            scan_ongoing = false;
          } else {
            document.getElementById("result").innerHTML = "<div style=\"color: var(--text-primary); padding: 1rem; background: rgba(0, 0, 0, 0.3); border-radius: 6px; border: 1px solid var(--border-color);\">Scanning Blockfilters... " + data + "%</div>";
            document.getElementById("loadingbar").setAttribute('aria-valuenow', data);
            document.getElementById("loadingbar").style.width = data + '%';
            document.getElementById("loadingbar").innerHTML = data + '%';
          }
        });
    }, 1000);
  });
});
</script>
{{end}}
